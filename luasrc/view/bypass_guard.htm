<%+cbi/valueheader%>
<%
local uci = require "luci.model.uci".cursor()
local sys = require "luci.sys" 
local fs = require "nixio.fs"
local is_running = (sys.call("/etc/init.d/bypass_guard status >/dev/null 2>&1") == 0)
%>

<div class="cbi-section">
    <h3><%=translate("Bypass Logic Traffic Statistics")%></h3>
    <div class="cbi-section-descr"><%=translate("Real-time packet and byte counters from nftables bypass_logic chain.")%></div>
    
    <table class="cbi-section-table" id="bypass_status_table">
        <tr class="cbi-section-table-titles">
            <th class="cbi-section-table-th"><%=translate("Traffic Type")%></th>
            <th class="cbi-section-table-th"><%=translate("Packets")%></th>
            <th class="cbi-section-table-th"><%=translate("Bytes")%></th>
            <th class="cbi-section-table-th"><%=translate("Action / Comment")%></th>
        </tr>
        <tr class="cbi-section-table-row">
            <td colspan="4"><em><%=translate("Collecting data...")%></em></td>
        </tr>
    </table>
</div>

<script type="text/javascript">//<![CDATA[
    // 动态更新表格内容
    XHR.poll(5, '<%=luci.dispatcher.build_url("admin", "services", "advanced", "guard_data")%>', nil,
        function(x, data) {
            var tb = document.getElementById('bypass_status_table');
            if (data && data.rules) {
                // 清除除了标题以外的所有行
                while (tb.rows.length > 1) tb.deleteRow(1);

                for (var i = 0; i < data.rules.length; i++) {
                    var r = data.rules[i];
                    var tr = tb.insertRow(-1);
                    tr.className = 'cbi-section-table-row cbi-rowstyle-' + ((i % 2) + 1);

                    tr.insertCell(-1).innerHTML = '<strong>' + r.name + '</strong>';
                    tr.insertCell(-1).innerHTML = r.packets;
                    tr.insertCell(-1).innerHTML = r.bytes;
                    tr.insertCell(-1).innerHTML = '<small>' + r.comment + '</small>';
                }
            } else {
                while (tb.rows.length > 1) tb.deleteRow(1);
                var tr = tb.insertRow(-1);
                var td = tr.insertCell(-1);
                td.colSpan = 4;
                td.innerHTML = '<em><%:Service not running or no data available%></em>';
            }
        }
    );

    function toggleBypass(action) {
        var btn = document.getElementById('guard_btn');
        btn.disabled = true;
        XHR.get('<%=luci.dispatcher.build_url("admin", "services", "advanced", "guard_status")%>', { set: action }, function(x, data) {
            location.reload();
        });
    }
//]]></script>

<div class="cbi-value">
    <div class="cbi-value-field">
        <% if is_running then %>
            <input type="button" id="guard_btn" class="btn cbi-button cbi-button-negative" onclick="toggleBypass('disable')" value="<%=translate('Stop Bypass Guard')%>" />
        <% else %>
            <input type="button" id="guard_btn" class="btn cbi-button cbi-button-positive" onclick="toggleBypass('enable')" value="<%=translate('Start Bypass Guard')%>" />
        <% end %>
    </div>
</div>

<%+cbi/valuefooter%>
