<%+cbi/valueheader%>
<%
local uci = require "luci.model.uci".cursor()
local sys = require "luci.sys" 
local fs = require "nixio.fs"
local uci_enabled = (uci:get("advanced", "global", "enable_bypass") == "1")
local nft_running = (sys.call("nft list table inet bypass_logic >/dev/null 2>&1") == 0)
local is_running = (uci_enabled and nft_running)
local has_natmap_conf = fs.access("/etc/config/natmap")
%>

<% if is_running then %>
<% if has_natmap_conf then %>
<div class="cbi-value" style="margin-top: 1rem;">
    <label class="cbi-value-title"><strong><%=translate("Natmap qB-port Direct")%></strong></label>
    <div class="cbi-value-field">
        <input type="checkbox" id="natmap_enable_cb" onchange="updateNatmapConfig(this.checked)" />
        <br />
        <div class="cbi-value-description">
            <span id="natmap_desc" style="color: <%=is_running and '#666' or '#999'%>">
                <%=translate("Update firewall rules automatically when Natmap port changes.")%>
            </span>
        </div>
    </div>
</div>
<% end %>

<div class="cbi-section">
    <div class="cbi-section-descr" style="padding-left: 3px; margin-top: 1rem;"><strong><%=translate("Bypass Logic Traffic Statistics")%></strong></div>
    <table class="cbi-section-table" id="bypass_status_table">
        <tr class="cbi-section-table-titles">
            <th class="cbi-section-table-th"><%=translate("Rule Name")%></th>
            <th class="cbi-section-table-th"><%=translate("Packets")%></th>
            <th class="cbi-section-table-th"><%=translate("Bytes")%></th>
            <th class="cbi-section-table-th"><%=translate("Action / Comment")%></th>
        </tr>
        <tr class="cbi-section-table-row">
            <td colspan="4"><em><%=translate("Collecting data...")%></em></td>
        </tr>
    </table>
</div>

<div class="cbi-section">
    <div class="cbi-section-descr" style="padding-left: 3px; margin-top: 1rem;"><strong><%=translate("VPN Clients")%></strong></div>
    <table class="cbi-section-table" id="clients_table">
        <tr class="cbi-section-table-titles">
            <th class="cbi-section-table-th"><%=translate("Hostname")%></th>
            <th class="cbi-section-table-th"><%=translate("MAC Address")%></th>
            <th class="cbi-section-table-th"><%=translate("IP Address")%></th>
            <th class="cbi-section-table-th"><%=translate("Type")%></th>
            <th class="cbi-section-table-th"><%=translate("Tag")%></th>
        </tr>
        <tr class="cbi-section-table-row">
            <td colspan="5"><em><%=translate("Fetching client list...")%></em></td>
        </tr>
    </table>
</div>

<% else %>
<div class="cbi-section">
    <div class="cbi-section-descr">
        <em style="color: #999;"><%:Statistics and Client list not available (Service is stopped)%></em>
    </div>
</div>
<% end %>

<style>
    .label { font-weight: bold; font-size: 0.9em; }
    #clients_table code { padding: 2px 4px; border-radius: 3px; }
</style>

<script type="text/javascript">//<![CDATA[
    <% if is_running then %>
    var last_bytes_map = {};
    function renderBytes(bytes) {
        if (bytes >= 1048576) return (bytes / 1048576).toFixed(2) + " MiB";
        if (bytes >= 1024) return (bytes / 1024).toFixed(2) + " KiB";
        return bytes.toFixed(0) + " B";
    }
    XHR.poll(5, '<%=luci.dispatcher.build_url("admin", "system", "advanced", "guard_data")%>', null,
        function(x, data) {
            var tb = document.getElementById('bypass_status_table');
            if (tb) {
                if (data && data.rules && data.rules.length > 0) {
                    while (tb.rows.length > 1) tb.deleteRow(1);
                    for (var i = 0; i < data.rules.length; i++) {
                        var r = data.rules[i];
                        var tr = tb.insertRow(-1);
                        tr.className = 'cbi-section-table-row cbi-rowstyle-' + ((i % 2) + 1);
                        tr.insertCell(-1).innerHTML = r.name
                        tr.insertCell(-1).innerHTML = r.packets;
                        var current_bytes = parseFloat(r.bytes_raw) || 0;
                        var speed_text = "";
                        if (last_bytes_map[r.name] !== undefined) {
                            var diff = (current_bytes - last_bytes_map[r.name]) / 5;
                            if (diff > 0) {
                                speed_text = ' <span style="color:#0069d6; font-size:0.8em; font-weight:bold;">↑ ' + renderBytes(diff) + '/s</span>';
                            }
                        }
                        last_bytes_map[r.name] = current_bytes;
                        tr.insertCell(-1).innerHTML = r.bytes + speed_text;
                        var actionHtml = '';
                        var c = r.comment || '';
                        if (c.indexOf('直连') > -1 || c.indexOf('Direct') > -1) {
                            actionHtml = '<span class="label" style="background-color:#46a546; color:white; padding:2px 6px; border-radius:3px; font-size:0.85em;">' + r.comment + '</span>';
                        } else if (c.indexOf('代理') > -1 || /Proxy|Agent/i.test(c)) {
                            actionHtml = '<span class="label" style="background-color:#0069d6; color:white; padding:2px 6px; border-radius:3px; font-size:0.85em;">' + r.comment + '</span>';
                        } else if (c.indexOf('NAT') > -1) {
                            actionHtml = '<span class="label" style="background-color:#d9822b; color:white; padding:2px 6px; border-radius:3px; font-size:0.85em;">' + r.comment + '</span>';
                        } else {
                            actionHtml = '<small>' + r.comment + '</small>';
                        }
                        tr.insertCell(-1).innerHTML = actionHtml;
                    }
                } else {
                    while (tb.rows.length > 1) tb.deleteRow(1);
                    var tr = tb.insertRow(-1);
                    var td = tr.insertCell(-1);
                    td.colSpan = 4;
                    td.innerHTML = '<em><%:No traffic data detected yet...%></em>';
                }
            }

            var tc = document.getElementById('clients_table');
            if (tc) {
                if (data && data.clients && data.clients.length > 0) {
                    while (tc.rows.length > 1) tc.deleteRow(1);
                    for (var i = 0; i < data.clients.length; i++) {
                        var c = data.clients[i];
                        var tr = tc.insertRow(-1);
                        tr.className = 'cbi-section-table-row cbi-rowstyle-' + ((i % 2) + 1);
                        tr.insertCell(-1).innerHTML = c.hostname ? c.hostname : '<em>unknown</em>';
                        tr.insertCell(-1).innerHTML = (c.mac || '—');
                        var ipStyle = (c.ip.indexOf(':') > -1) ? 'style="font-size:0.85em; word-break:break-all;"' : '';
                        tr.insertCell(-1).innerHTML = '<span ' + ipStyle + '>' + c.ip + '</span>';
                        tr.insertCell(-1).innerHTML = (c.ip.indexOf(':') > -1) ? 'IPv6' : 'IPv4';
                        var roleHtml = '<span class="label" style="background-color:#46a546; color:white; padding:2px 4px; border-radius:3px;">VPN</span>';
                        if (c.is_server) {
                            roleHtml += ' <span class="label" style="background-color:#0069d6; color:white; padding:2px 4px; border-radius:3px; margin-left:4px;">Server</span>';
                        }
                        tr.insertCell(-1).innerHTML = roleHtml;
                    }
                } else {
                    while (tc.rows.length > 1) tc.deleteRow(1);
                    var tr = tc.insertRow(-1);
                    var td = tr.insertCell(-1);
                    td.colSpan = 5;
                    td.innerHTML = '<em><%:No redirection clients found in NFT sets.%></em>';
                }
            }
        }
    );
    <% end %>

    document.addEventListener("DOMContentLoaded", function() {
        var cb = document.getElementById('natmap_enable_cb');
        if (cb) {
            XHR.get('<%=luci.dispatcher.build_url("admin", "system", "advanced", "get_guard_config")%>', null, function(x, data) {
                if (data) {
                    cb.checked = (data.enable_natmap === '1');
                }
            });
        }
    });

    function updateNatmapConfig(isChecked) {
        var cb = document.getElementById('natmap_enable_cb');
        var desc = document.getElementById('natmap_desc');
        var val = isChecked ? '1' : '0';
        if (cb) cb.disabled = true;
        if (desc) desc.innerHTML = '<%:Saving...%>';
        XHR.get('<%=luci.dispatcher.build_url("admin", "system", "advanced", "set_natmap")%>', { set: val }, function(x, data) {
            if (cb) cb.disabled = false;
            if (desc) desc.innerHTML = '<%=translate("Update firewall rules automatically when Natmap port changes.")%>';
            if (!data || data.code !== 0) {
                alert('<%:Config Update Failed%>');
                if (cb) cb.checked = !isChecked;
            }
        });
    }

    function toggleBypass(action) {
        var btn = document.getElementById('guard_btn');
        btn.disabled = true;
        btn.value = '<%:Applying...%>';
        XHR.get('<%=luci.dispatcher.build_url("admin", "system", "advanced", "guard_status")%>', { set: action }, function(x, data) {
            location.reload();
        });
    }
//]]></script>

<div class="cbi-value" style="padding-left: 3px; margin-top: 0.5rem;">
    <div class="cbi-value-field">
        <% if is_running then %>
            <input type="button" id="guard_btn" class="btn cbi-button cbi-button-negative" onclick="toggleBypass('disable')" value="<%=translate('Stop Bypass Guard')%>" />
        <% else %>
            <input type="button" id="guard_btn" class="btn cbi-button cbi-button-positive" onclick="toggleBypass('enable')" value="<%=translate('Start Bypass Guard')%>" />
        <% end %>
    </div>
</div>
<%+cbi/valuefooter%>
